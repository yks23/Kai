"""
æŒä¹…åŒ–ç”¨æˆ·é…ç½® â€” å­˜å‚¨åœ¨ ~/.config/kai/settings.json

æ”¯æŒçš„é…ç½®é¡¹:
  base_dir  â€” å·¥ä½œåŒºç›®å½• (kai base <path>)
  cli_name  â€” CLI å‘½ä»¤å (kai name <name>)
"""
import json
import os
import shutil
import sys
from pathlib import Path

# é…ç½®æ–‡ä»¶è·¯å¾„
_CONFIG_DIR = Path.home() / ".config" / "kai"
_SETTINGS_FILE = _CONFIG_DIR / "settings.json"

# é»˜è®¤å€¼
_DEFAULTS = {
    "base_dir": "",       # ç©º = ä½¿ç”¨ CWD
    "cli_name": "kai",    # é»˜è®¤å‘½ä»¤å
}


def _ensure_config_dir():
    _CONFIG_DIR.mkdir(parents=True, exist_ok=True)


def load_settings() -> dict:
    """åŠ è½½æŒä¹…åŒ–é…ç½®ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼"""
    if _SETTINGS_FILE.exists():
        try:
            with open(_SETTINGS_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
            # åˆå¹¶é»˜è®¤å€¼ (å…¼å®¹æ—§ç‰ˆé…ç½®ç¼ºå°‘æ–°å­—æ®µ)
            merged = {**_DEFAULTS, **data}
            return merged
        except (json.JSONDecodeError, OSError):
            return dict(_DEFAULTS)
    return dict(_DEFAULTS)


def save_settings(settings: dict):
    """ä¿å­˜é…ç½®åˆ°ç£ç›˜"""
    _ensure_config_dir()
    with open(_SETTINGS_FILE, "w", encoding="utf-8") as f:
        json.dump(settings, f, indent=2, ensure_ascii=False)


# ============ ä¾¿æ·æ¥å£ ============

def get_base_dir() -> str:
    """è·å–å·²ä¿å­˜çš„ base_dir (ç©ºå­—ç¬¦ä¸² = æœªè®¾ç½®ï¼Œä½¿ç”¨ CWD)"""
    return load_settings().get("base_dir", "")


def set_base_dir(path: str):
    """è®¾ç½®å¹¶æŒä¹…åŒ– base_dir"""
    s = load_settings()
    s["base_dir"] = path
    save_settings(s)


def get_cli_name() -> str:
    """è·å–å½“å‰ CLI å‘½ä»¤å"""
    return load_settings().get("cli_name", "kai")


def set_cli_name(new_name: str):
    """
    é‡å‘½å CLI å‘½ä»¤:
      1. åœ¨ bin ç›®å½•åˆ›å»ºç¬¦å·é“¾æ¥ new_name â†’ åŸå§‹å…¥å£
      2. ä¿å­˜åˆ°é…ç½®
    """
    old_name = get_cli_name()

    # æ‰¾åˆ°å½“å‰å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨çš„ bin ç›®å½•
    bin_dir = _find_bin_dir()
    if not bin_dir:
        print(f"   âš ï¸ æ— æ³•å®šä½ bin ç›®å½•ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºåˆ«å:")
        print(f"      alias {new_name}='kai'")
        s = load_settings()
        s["cli_name"] = new_name
        save_settings(s)
        return False

    # æº: kai çš„å®é™…å…¥å£è„šæœ¬
    src = bin_dir / "kai"
    dest = bin_dir / new_name

    if not src.exists():
        # å¯èƒ½é€šè¿‡å…¶ä»–åå­—å®‰è£…çš„
        src = bin_dir / "secretary"
        if not src.exists():
            src = bin_dir / old_name

    if dest.exists() or dest.is_symlink():
        dest.unlink()

    try:
        if src.exists():
            # åˆ›å»ºç¬¦å·é“¾æ¥: lily â†’ kai (æˆ–å¤åˆ¶è„šæœ¬)
            os.symlink(src, dest)
            print(f"   âœ… å·²åˆ›å»º: {dest} â†’ {src.name}")
        else:
            # å¦‚æœæ‰¾ä¸åˆ°æºï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªå° wrapper
            _create_wrapper_script(dest)
            print(f"   âœ… å·²åˆ›å»ºå…¥å£è„šæœ¬: {dest}")
    except OSError as e:
        print(f"   âš ï¸ åˆ›å»ºé“¾æ¥å¤±è´¥: {e}")
        print(f"   ğŸ’¡ è¯·æ‰‹åŠ¨æ‰§è¡Œ: alias {new_name}='kai'")

    s = load_settings()
    s["cli_name"] = new_name
    save_settings(s)
    return True


def _find_bin_dir() -> Path | None:
    """æ‰¾åˆ° pip å®‰è£…è„šæœ¬çš„ bin ç›®å½•"""
    # æ–¹æ³•1: ä» sys.executable æ¨æ–­
    # venv: .../venv/bin/python â†’ .../venv/bin/
    # system: /usr/bin/python â†’ ~/.local/bin/ (user install)
    venv_bin = Path(sys.executable).parent
    if (venv_bin / "kai").exists() or (venv_bin / "secretary").exists():
        return venv_bin

    # æ–¹æ³•2: å¸¸è§çš„ user bin
    user_bin = Path.home() / ".local" / "bin"
    if user_bin.exists():
        if (user_bin / "kai").exists() or (user_bin / "secretary").exists():
            return user_bin

    # æ–¹æ³•3: ä» PATH æœç´¢
    for name in ["kai", "secretary"]:
        found = shutil.which(name)
        if found:
            return Path(found).parent

    return venv_bin if venv_bin.exists() else None


def _create_wrapper_script(dest: Path):
    """åˆ›å»ºä¸€ä¸ª Python wrapper è„šæœ¬"""
    script = f"""#!/usr/bin/env python3
# Auto-generated by kai name command
from secretary.cli import main
main()
"""
    dest.write_text(script, encoding="utf-8")
    dest.chmod(0o755)

