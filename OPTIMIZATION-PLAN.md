# 仓库优化方案（易用性、可移植性、额外功能）

本文档从三个维度整理本仓库的优化方向，便于按优先级落地。与 [IMPROVEMENTS.md](./IMPROVEMENTS.md) 互补：此处按「视角」组织，IMPROVEMENTS 按「类别」与 P0/P1/P2 已标项组织。

---

## 一、易用性

目标：降低使用门槛、简化配置与启动、改进文档与交互。

| 序号 | 优化项 | 说明 | 建议优先级 |
|------|--------|------|------------|
| 1.1 | 示例任务 | 在 `tasks/` 或 `docs/` 下提供 1～2 个示例任务 `.md`，方便新用户模仿格式与描述方式。 | P1 |
| 1.2 | 故障排查文档 | 在 README 或 `docs/TROUBLESHOOTING.md` 中写常见问题：如 `cursor` 找不到、任务一直不完成、工作区解析失败等，并给出解决步骤。 | P1 |
| 1.3 | 配置示例 | 提供 `config.example.py` 或 `.env.example`，列出所有可配置项及示例值，便于复制修改。 | P2 |
| 1.4 | 启动前检查 | 启动时检测 `cursor` 是否在 PATH 中、工作区与 tasks/ongoing/report 目录是否可写，不可用时给出明确提示与安装/配置说明。 | P1 |
| 1.5 | 单任务执行 | 支持只执行指定任务文件，如 `python main.py run tasks/xxx.md`，不经过扫描器，便于调试与单次运行。 | P1 |
| 1.6 | 任务取消/移回 | 支持将 `ongoing/` 中某任务移回 `tasks/` 或标记为取消，避免误删或长期占用。 | P1 |
| 1.7 | Worker 工作区解析 | 在任务模板中固定 `## 工作区` 下一行即路径，在 `worker.py` 中按此约定解析，替代当前启发式逻辑，减少误判。 | P1 |

---

## 二、可移植性

目标：环境依赖清晰、路径与配置可移植、支持跨平台与多环境部署。

| 序号 | 优化项 | 说明 | 建议优先级 |
|------|--------|------|------------|
| 2.1 | 路径可配置 | 当前 `config.py` 已用 `BASE_DIR` 派生路径；确保所有读写均通过 config 的常量，避免硬编码绝对路径。 | P0（已基本满足，做一次核查即可） |
| 2.2 | 环境变量覆盖 | 保持并文档化 `CURSOR_BIN`、`CURSOR_MODEL`、`SCAN_INTERVAL`、`RETRY_INTERVAL` 等，便于不同环境（开发/CI/多机）覆盖。 | P1 |
| 2.3 | 可选 .env 支持 | 若引入第三方库，可增加对 `.env` 的加载（如 python-dotenv），使本地配置与代码分离，便于迁移。 | P2 |
| 2.4 | 跨平台路径与 Shell | 使用 `Path` 与 `os.path` 保持路径兼容；若 Worker 生成的命令需在 Windows 运行，在文档或规则中说明差异。 | P1 |
| 2.5 | 依赖声明 | 当前仅用标准库；若未来引入第三方库，增加 `requirements.txt` 或 `pyproject.toml`，并注明最低 Python 版本（如 3.10+）。 | P2 |
| 2.6 | 多工作区/工作区池 | 支持任务绑定不同工作区或「工作区池」，在 Worker 调用时传入对应 `--workspace`，便于多项目部署。 | P2 |

---

## 三、额外功能

目标：在现有能力上扩展，提升秘书 Agent 的实用价值。

| 序号 | 优化项 | 说明 | 建议优先级 |
|------|--------|------|------------|
| 3.1 | 任务优先级/标签 | 任务文件名或内容支持优先级/标签，扫描器按优先级或标签顺序处理。 | P2 |
| 3.2 | 超时与重试策略 | 对单次 Worker 调用设超时（`agent_runner.run_agent` 已支持 timeout），超时后重试或标记失败，避免无限挂起。 | P1 |
| 3.3 | 失败标记与 failed/ | Worker 明确失败（如多次报错/超时）时，将任务移入 `failed/` 或追加失败标记并写简短报告，避免无限重试。 | P1 |
| 3.4 | 扫描器单任务模式 | 可选：一次只取一个任务，处理完再取下一个，便于控制并发与资源。 | P2 |
| 3.5 | 日志与可观测性 | 用 `logging` 替代部分 `print`，支持日志级别与输出到文件，便于排查与审计。 | P2 |
| 3.6 | Web/API 或简单 UI | 提供简单 HTTP 或 Web 界面提交任务、查看状态与报告。 | 扩展 |
| 3.7 | 通知 | 任务完成或失败时发送通知（邮件、Webhook、桌面通知等）。 | 扩展 |
| 3.8 | 统计与报表 | 统计任务数量、完成率、平均耗时等，输出简单报表（可基于现有 `*-stats.json`）。 | 扩展 |

---

## 四、优先级与落地建议

- **P0**：必须满足或已满足，仅需核查。
- **P1**：建议优先落地，对易用性与可移植性、可靠性影响大。
- **P2**：在 P1 完成后按需推进。
- **扩展**：中长期按需求排期。

### 建议的拆分子任务（可单独建任务文件）

| 子任务 | 对应项 | 说明 |
|--------|--------|------|
| 改进 README / 故障排查 | 1.2 | 新增 `docs/TROUBLESHOOTING.md` 或在 README 增加「常见问题」小节。 |
| 统一配置方式与示例 | 1.3, 2.2 | 新增 `config.example.py` 或 `.env.example`，并在 README 中说明。 |
| 启动前环境检查 | 1.4 | 在 `main.py` 或独立模块中增加 `cursor` 与目录可写检查。 |
| 单任务执行命令 | 1.5 | 新增 `python main.py run <task_file>`，直接调用 Worker 不经过 Scanner。 |
| Worker 工作区解析约定 | 1.7 | 约定任务模板格式，修改 `worker.py` 的 `_try_parse_workspace`。 |
| 超时与失败处理 | 3.2, 3.3 | Scanner/Worker 传入 timeout；失败时移入 `failed/` 并写报告。 |

落实时建议：先做 P1 中与当前痛点最相关的几项，再逐步推进 P2 与扩展项。具体条目与优先级可与 [IMPROVEMENTS.md](./IMPROVEMENTS.md) 对齐后执行。

---

## 五、可跟踪优化项清单

以下为按优先级整理的可勾选清单，便于逐项落地与跟踪。完成一项可将 `[ ]` 改为 `[x]`。

### 易用性

| 状态 | 编号 | 优化项 |
|------|------|--------|
| [ ] | 1.1 | 示例任务：在 `docs/` 或 README 中提供 1～2 个示例任务 `.md` |
| [ ] | 1.2 | 故障排查：新增 `docs/TROUBLESHOOTING.md` 或 README 常见问题小节 |
| [ ] | 1.3 | 配置示例：提供 `config.example.py` 或 `.env.example` |
| [ ] | 1.4 | 启动前检查：检测 `cursor` 与目录可写，不可用时明确提示 |
| [ ] | 1.5 | 单任务执行：新增 `python main.py run <task_file>` |
| [ ] | 1.6 | 任务取消/移回：支持将 ongoing 中任务移回 tasks 或标记取消 |
| [ ] | 1.7 | Worker 工作区解析：约定 `## 工作区` 下一行即路径，修改 `worker.py` |

### 可移植性

| 状态 | 编号 | 优化项 |
|------|------|--------|
| [x] | 2.1 | 路径可配置：核查所有读写均通过 config 常量 |
| [ ] | 2.2 | 环境变量：在 README 中完整列出并说明各变量 |
| [ ] | 2.3 | 可选 .env：引入 python-dotenv 等支持 `.env` |
| [ ] | 2.4 | 跨平台：文档中说明 Windows 与 Unix 差异 |
| [ ] | 2.5 | 依赖声明：若有第三方库则增加 `requirements.txt` / `pyproject.toml` |
| [ ] | 2.6 | 多工作区/工作区池：任务绑定不同 `--workspace` |

### 额外功能

| 状态 | 编号 | 优化项 |
|------|------|--------|
| [ ] | 3.1 | 任务优先级/标签：扫描器按优先级或标签顺序处理 |
| [ ] | 3.2 | 超时与重试：Scanner/Worker 传入 `timeout`，超时后重试或标记 |
| [ ] | 3.3 | 失败标记：失败时移入 `failed/` 并写简短报告 |
| [ ] | 3.4 | 扫描器单任务模式：可选一次只取一个任务 |
| [ ] | 3.5 | 日志：用 `logging` 替代部分 `print`，支持级别与文件输出 |
| [ ] | 3.6 | Web/API 或简单 UI（扩展） |
| [ ] | 3.7 | 通知：完成/失败时邮件、Webhook 等（扩展） |
| [ ] | 3.8 | 统计与报表（扩展） |
